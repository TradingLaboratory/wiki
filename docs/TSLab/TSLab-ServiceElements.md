# Сервисные элементы (Service Elements)

Сервисные элементы — вспомогательные кубики визуального конструктора TSLab, предназначенные для организации логики стратегии: работы с глобальным кешем, вывода сообщений в лог, управления событиями и таймерами, а также получения ссылок на финансовые инструменты в мульти-источниках. Эти кубики не производят расчётов индикаторов, но обеспечивают инфраструктурную поддержку торговой системы.

## Группировка кубиков

### Работа с финансовыми инструментами

#### InstrumentByName (Инструмент по имени)

- **Входные параметры**: `ISecurity[] securities` — массив финансовых инструментов из мульти-источника
- **Выход**: `ISecurity` — найденный финансовый инструмент
- **Описание**: Возвращает финансовый инструмент из мульти-источника по его имени. Если инструмент с указанным именем не найден, возвращается первый инструмент в списке.
- **Описание от разработчиков**: Найти инструмент по имени в мульти-источнике. Если инструмент не найден по имени, то возвращает первый по списку.

#### InstrumentByNumber (Инструмент по номеру)

- **Входные параметры**: `int Number` — порядковый номер инструмента в мульти-источнике (начиная с 0)
- **Выход**: `ISecurity` — финансовый инструмент
- **Описание**: Возвращает финансовый инструмент из мульти-источника по его порядковому номеру.
- **Описание от разработчиков**: Найти инструмент по номеру в мульти-источнике.

### Работа с глобальным кешем

#### SaveToGlobalCache2 (Сохранить в Глобальный Кеш)

- **Входные параметры**: 
  - `ISecurity sec` — финансовый инструмент
  - `double value` — сохраняемое значение индикатора
  - `int index` — индекс бара (обычно текущий)
- **Выход**: отсутствует (кубик выполняет побочный эффект)
- **Описание**: Сохраняет последнее значение индикатора в глобальный кеш для последующего использования в других стратегиях или сессиях. Данные сохраняются в файл `Temp\GlobalCache_[имя].txt`.
- **Описание от разработчиков**: Сохранить значение любого индикатора в Глобальный Кеш. Последнее значение записывается. Записанные данные можно просмотреть в файле Temp\GlobalCache_'name'.txt.

#### LoadFromGlobalCache2 (Загрузить из Глобального Кеша)

- **Входные параметры**: `ISecurity sec` — финансовый инструмент
- **Выход**: `IList<double>` — список значений, загруженных из кеша
- **Описание**: Загружает ранее сохранённые значения индикатора из глобального кеша для использования в текущей стратегии.
- **Описание от разработчиков**: Загрузить значение индикатора из Глобального Кеша.

### Сообщения и логирование

#### MessageHandler (Сообщение)

- **Входные параметры**: `bool Input` — триггер активации (при значении `Истина`)
- **Выход**: отсутствует
- **Описание**: Выводит пользовательское сообщение в лог TSLab при активации входного сигнала.
- **Описание от разработчиков**: При появлении на входе блока значения 'Истина' выводит в лог программы пользовательское сообщение.

#### FormatMessageHandler (Форматированное сообщение)

- **Входные параметры**: 
  - `ISecurity sec` — финансовый инструмент
  - `bool value` — триггер активации
  - `params object[] values` — параметры для форматирования сообщения
- **Выход**: `string` — отформатированное сообщение
- **Описание**: Формирует и выводит в лог TSLab сообщение с подстановкой динамических значений (цена, время, объём и т.д.).
- **Описание от разработчиков**: При появлении на входе блока значения 'Истина' выводит в лог программы форматированное сообщение.

#### ControlMessageHandler (Контрольное сообщение)

- **Входные параметры**: `IList<bool> values` — список булевых значений для управления выводом
- **Выход**: отсутствует
- **Описание**: Выводит в лог TSLab контрольные сообщения в зависимости от состояния входных булевых значений.
- **Описание от разработчиков**: Выводит контрольное сообщение.

#### ExportValuesHandler (Экспорт значений)

- **Входные параметры**: 
  - `ISecurity security` — финансовый инструмент
  - `IList<bool> values` — список значений для экспорта
- **Выход**: отсутствует
- **Описание**: Экспортирует значения в лог TSLab по пользовательскому идентификатору для последующего анализа или отладки.
- **Описание от разработчиков**: Передаёт значение по идентификатору, заданному пользователем.

### События и таймеры

#### HeartbeatHandler (Метроном 2)

- **Входные параметры**: отсутствуют
- **Выход**: отсутствуют
- **Описание**: Генерирует периодические события (тиков) с заданной частотой для синхронизации действий стратегии во времени.
- **Описание от разработчиков**: Метроном 2.

#### HeartbeatManager (Менеджер метронома)

- **Входные параметры**: отсутствуют
- **Выход**: отсутствуют
- **Описание**: Управляет состоянием и регистрацией обработчиков для периодических событий в системе TSLab.
- **Описание от разработчиков**: Класс, который управляет состоянием и регистрацией обработчиков для периодических событий.

#### EventKindHandler (Событие)

- **Входные параметры**: `ISecurity source` — финансовый инструмент-источник события
- **Выход**: `EventKind` — тип события (например, новая свеча, тик, закрытие позиции)
- **Описание**: Определяет и возвращает тип текущего события, произошедшего с финансовым инструментом.
- **Описание от разработчиков**: Вид события.

### Временные метки

#### TimestampHandler (Временная метка)

- **Входные параметры**: отсутствуют
- **Выход**: отсутствуют (внутренняя реализация возвращает миллисекунды)
- **Описание**: Предоставляет доступ к временным меткам в миллисекундах с начала эпохи Unix для точной синхронизации операций.
- **Описание от разработчиков**: Класс для получения временных меток в миллисекундах с начала эпохи Unix.

---

## Советы по использованию

- **Глобальный кеш** идеально подходит для передачи данных между стратегиями, запущенными на разных инструментах или таймфреймах. Например, можно сохранить сигнал с таймфрейма H1 и использовать его на M5.
- **InstrumentByName/ByNumber** критически важны при работе с мульти-источниками — всегда проверяйте корректность имени или номера инструмента перед использованием.
- **HeartbeatHandler** позволяет создавать стратегии, реагирующие на время (например, закрытие позиций за 5 минут до закрытия рынка), а не только на появление новых баров.
- **FormatMessageHandler** используйте для отладки сложных условий — выводите значения индикаторов, цены входа и текущее время в одном сообщении.
- **ControlMessageHandler** помогает визуализировать логику работы стратегии в реальном времени — подключите его к выходам ключевых условий для мониторинга состояния системы.
- Избегайте избыточного использования кубиков логирования в продакшен-стратегиях — большое количество сообщений может замедлить выполнение.

#tslab #serviceelements #сервисныеэлементы #логирование #кеш #мультиисточник