# Position (Управление позициями)

Кубики категории **Position** предназначены для анализа текущих и исторических позиций, получения параметров входа/выхода, расчёта финансовых результатов и управления логикой торговли на основе состояния позиций. Позволяют строить сложные правила выхода, отслеживать серию прибыльных/убыточных сделок и реализовывать динамические стоп-лоссы.

## Проверка состояния позиций

### HasPositionActive (Есть активная позиция)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `bool`
- **Описание**: Проверяет наличие хотя бы одной открытой позиции по инструменту на текущем баре.
- **Описание от разработчиков**: Логическая функция проверяющая наличие активной позиции.
- **Примеры**: [Стратегия Alligator](http://www.tslab.ru/files/script/Alligator_tradable.tscript)

### HasLongPositionActive (Есть активная длинная позиция)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `bool`
- **Описание**: Возвращает истину, если по инструменту открыта длинная (покупка) позиция.
- **Описание от разработчиков**: Логическая функция проверяющая наличие активной длинной позиции.
- **Примеры**: [Стратегия Hi/Lo 1 позиция](http://www.tslab.ru/files/script/Hi_Lo_1pos.tscript)

### HasShortPositionActive (Есть активная короткая позиция)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `bool`
- **Описание**: Возвращает истину, если по инструменту открыта короткая (продажа) позиция.
- **Описание от разработчиков**: Логическая функция проверяющая наличие активной короткой позиции.
- **Примеры**: [Стратегия Hi/Lo 1 позиция](http://www.tslab.ru/files/script/Hi_Lo_1pos.tscript)

### PositionIsVirtualHandler (Виртуальная позиция?)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `bool`
- **Описание**: Проверяет, является ли позиция виртуальной (рассчитанной в режиме симуляции без реальных сделок).
- **Описание от разработчиков**: Возвращает значение Истина, если позиция на входе является виртуальной.

### PositionIsVirtualClosedHandler (Виртуальный выход из позиции?)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `bool`
- **Описание**: Определяет, закрыта ли позиция виртуально (расчётно, до исполнения реальных заявок).
- **Описание от разработчиков**: Позиция закрыта виртуально (рассчетно, сделок еще не было)?

### LastClosedIsLong (Посл. поз. закрыта и длинная)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `bool`
- **Описание**: Проверяет, что последняя закрытая позиция по инструменту была длинной и уже закрыта.
- **Описание от разработчиков**: Последняя позиция была закрыта и она длинная.

### LastClosedIsLong2 (Посл. закр. поз. была длинной)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `bool`
- **Описание**: Логическая функция, проверяющая что последняя закрытая позиция была длинной.
- **Описание от разработчиков**: Логическая функция проверяющая, что последняя закрытая позиция была длинной.

### LastClosedIsShort (Посл. поз. закрыта и короткая)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `bool`
- **Описание**: Проверяет, что последняя закрытая позиция по инструменту была короткой и уже закрыта.
- **Описание от разработчиков**: Последняя позиция была закрыта и она короткая.

### LastClosedIsShort2 (Посл. закр. поз. была короткой)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `bool`
- **Описание**: Логическая функция, проверяющая что последняя закрытая позиция была короткой.
- **Описание от разработчиков**: Логическая функция проверяющая, что последняя закрытая позиция была короткой.

### IsItLossAtLastPosition (Последняя закрытая позиция убыточна)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `bool`
- **Описание**: Возвращает истину, если последняя закрытая позиция завершилась с убытком.
- **Описание от разработчиков**: Проверяет наличие убытка по закрытой позиции.

### HasTwoLoss (2 убытка подряд)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `bool`
- **Описание**: Сигнализирует о наличии двух или более последовательных убыточных позиций.
- **Описание от разработчиков**: Наличие двух или более убыточных позиций подряд.

## Параметры входа и выхода

### EntryPrice (Цена входа)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Возвращает фактическую цену открытия позиции. В режиме реальной торговли — цена исполнения заявки.
- **Описание от разработчиков**: Цена сделки, по которой открылась позиция. Для режима реальных торгов это цена по которой была выставлена заявка на открытие позиции.

### EntryDate (Дата входа)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double` (число в формате ГГММДД)
- **Описание**: Дата открытия позиции в числовом формате YYMMDD.
- **Описание от разработчиков**: Дата входа в позицию, представленная как число в формате ГГММДД.

### EntryTime (Время входа)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double` (число в формате ЧЧММСС)
- **Описание**: Время открытия позиции в числовом формате HHMMSS.
- **Описание от разработчиков**: Время входа в позицию, представленное как число в формате ЧЧММСС.

### CalcEntryPrice (Цена входа (расчетная))
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Расчётная цена входа в позицию с учётом комиссий и проскальзывания.
- **Описание от разработчиков**: Расчетная цена сделки, по которой открылась позиция.

### LastExitPrice (Цена последнего выхода)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Цена последней сделки закрытия позиции по инструменту.
- **Описание от разработчиков**: Цена последнего выхода.

### AverageExitPrice (Средняя цена выхода)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Средневзвешенная цена всех сделок выхода из позиции.
- **Описание от разработчиков**: Средняя цена выхода из позиции.

### LastExitAvgPrice (Средняя цена выхода последней позиции)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Средняя цена выхода из последней закрытой позиции по инструменту.
- **Описание от разработчиков**: Средняя цена выхода последней позиции.

## Средние цены входа

### BalancedPrice (Средняя цена входа)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Средневзвешенная цена всех сделок входа в текущую позицию.
- **Описание от разработчиков**: Средняя цена входа в позицию.

### BalancedPriceBySecurity (Средняя цена входа (по инструменту))
- **Входные параметры**: `ISecurity sec` — финансовый инструмент, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Средняя цена входа для всех активных позиций по инструменту (учитывает усреднения).
- **Описание от разработчиков**: Средняя цена входа и изменения всех активных позиций скрипта по инструменту.

### PositionChangeEntryPrice (Цена входа в измененную позицию)
- **Входные параметры**: `IPosition position` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Цена последнего дополнения (усреднения) позиции при частичном входе.
- **Описание от разработчиков**: Показывает цену последнего входа в сложносоставную позицию.

### PositionChangeEntryBarNumber (Номер бара входа в измененную позицию)
- **Входные параметры**: `IPosition position` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Номер бара, на котором была изменена позиция при дополнительном входе.
- **Описание от разработчиков**: Показывает номер бара входа в измененную сложносоставную позицию.

## Номера баров и временные параметры

### PositionEntryBarNumber (Номер бара входа в позицию)
- **Входные параметры**: `IPosition position` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Порядковый номер бара, на котором была открыта позиция.
- **Описание от разработчиков**: Показывает порядковый номер бара в момент входа в позицию.

### PositionExitBarNumber (Номер бара выхода из позиции)
- **Входные параметры**: `IPosition position` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Порядковый номер бара, на котором позиция была закрыта.
- **Описание от разработчиков**: Показывает порядковый номер бара в момент выхода из позиции.

### BarsHeld (Удерживалось баров)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Количество баров, в течение которых удерживалась позиция (от входа до текущего момента или выхода).
- **Описание от разработчиков**: Возвращает количество баров удержания позиции.

### MinutesInPosition (Минут в позиции)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Точное время удержания позиции в минутах с момента входа.
- **Описание от разработчиков**: Количество минут в позиции с момента входа.

### DaysInPosition (Дней в позиции)
- **Входные параметры**: `IPosition pos` — объект позиции
- **Выход**: `double`
- **Описание**: Количество календарных дней удержания позиции.
- **Описание от разработчиков**: Количество дней в позиции с момента входа.

### LastClosedPositionExitBarNumber (Номер бара выхода из последней закрытой позиции)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Номер бара, на котором была закрыта последняя позиция по инструменту.
- **Описание от разработчиков**: Номер бара выхода из последней закрытой позиции.

### LastClosedPositionExitDate (Дата выхода последней закрытой позиции)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Дата закрытия последней позиции по инструменту.
- **Описание от разработчиков**: Дата выхода последней закрытой позиции.

### LastClosedPositionExitTime (Время выхода последней закрытой позиции)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Время закрытия последней позиции по инструменту.
- **Описание от разработчиков**: Время выхода последней закрытой позиции.

### LastClosedPositionTime (Время последней закрытой позиции)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Время последней закрытой позиции.
- **Описание от разработчиков**: Время последней закрытой позиции.

### LastClosedPositionDate (Дата последней закрытой позиции)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Дата последней закрытой позиции.
- **Описание от разработчиков**: Дата последней закрытой позиции.

### LastClosedNamePositionExitDate (Дата выхода последней закрытой позиции по имени)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Дата выхода последней закрытой позиции с указанным именем блока закрытия.
- **Описание от разработчиков**: Дата выхода последней закрытой позиции по имени.

### LastClosedNamePositionExitPrice (Цена выхода последней закрытой позиции по имени)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Цена выхода последней закрытой позиции с указанным именем блока закрытия.
- **Описание от разработчиков**: Цена выхода последней закрытой позиции по имени.

### LastClosedNamePositionExitTime (Время выхода последней закрытой позиции по имени)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Время выхода последней закрытой позиции с указанным именем блока закрытия.
- **Описание от разработчиков**: Время выхода последней закрытой позиции по имени.

### LastClosedNamePositionAvgExitPrice (Средняя цена выхода последней позиции по имени)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Средняя цена выхода последней закрытой позиции с указанным именем блока закрытия.
- **Описание от разработчиков**: Средняя цена выхода последней позиции по имени.

## Размер позиции и серия сделок

### PositionShares (Количество (Начальное))
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Исходный объём позиции в лотах (до частичных выходов или усреднений).
- **Описание от разработчиков**: Количество оригинальных лотов в позиции (до изменения их в режиме симуляции портфеля).

### PositionSharesByBar (Количество)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Текущий объём позиции в лотах на каждом баре (с учётом частичных выходов/входов).
- **Описание от разработчиков**: На каждом баре возвращает текущий размер позиции в лотах.

### ProfitsCount (Прибыльных подряд)
- **Входные параметры**: `ISecurity source` — финансовый инструмент, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Количество последовательных прибыльных закрытых позиций подряд.
- **Описание от разработчиков**: Подсчет количества прибыльных позиций подряд.

### DrowdownCount (Убытков подряд)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Количество последовательных убыточных закрытых позиций подряд.
- **Описание от разработчиков**: Подсчет количества убыточных позиций подряд.

## Финансовые результаты

### Profit (Доход)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Текущая прибыль/убыток позиции в денежном выражении (на один лот/контракт).
- **Описание от разработчиков**: Доход (убыток) приносимый позицией в абсолютных величинах.

### ProfitPct (Доход %)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Текущая прибыль/убыток позиции в процентах от цены входа (на один лот/контракт).
- **Описание от разработчиков**: Доход (убыток) приносимый позицией в процентах.

### DrawdownHandler (Просадка)
- **Входные параметры**: `ISecurity source` — финансовый инструмент
- **Выход**: `double`
- **Описание**: Текущая просадка в денежном выражении: разница между текущей прибылью и максимальной достигнутой прибылью.
- **Описание от разработчиков**: Расчеты: Просадка = Профит - МаксФиксПрофит.

### Median (Просадка (кривой) прибыли)
- **Входные параметры**: `Input` — входной поток данных
- **Выход**: `OutputType`
- **Описание**: Отклонение кривой капитала от медианного значения (показатель стабильности стратегии).
- **Описание от разработчиков**: Показывает отклонение кривой прибыли от медианы.
- **Примеры**: [Стратегия Alligator](http://www.tslab.ru/files/script/Alligator_tradable.xml)

## Экстремальные отклонения (MFE/MAE)

### MFE (MFE)
- **Входные параметры**: `Input` — входной поток данных
- **Выход**: `OutputType`
- **Описание**: Максимальное благоприятное отклонение цены — наибольшая нереализованная прибыль в абсолютных величинах (на один лот).
- **Описание от разработчиков**: Maximum Favorable Excursion - максимальное благоприятное отклонение цены от позиции в абсолютных величинах. В расчете на один контракт/лот.

### MFEPct (MFE %)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Максимальное благоприятное отклонение в процентах от цены входа.
- **Описание от разработчиков**: Максимальное благоприятное отклонение цены от позиции в процентах.

### MAE (MAE)
- **Входные параметры**: `Input` — входной поток данных
- **Выход**: `OutputType`
- **Описание**: Максимальное неблагоприятное отклонение цены — наибольший нереализованный убыток в абсолютных величинах (на один лот).
- **Описание от разработчиков**: Maximum Adverse Excursion - максимальное неблагоприятное отклонение цены от позиции в абсолютных величинах. В расчете на один контракт/лот.

### MAEPct (MAE %)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Максимальное неблагоприятное отклонение в процентах от цены входа.
- **Описание от разработчиков**: Maximum Adverse Excursion - максимальное неблагоприятное отклонение цены от позиции в процентах. В расчете на один контракт/лот.
- **Примеры**: [Стратегия 2МА с нестандартным стопом](http://www.tslab.ru/files/script/2MA_customStop.tscript)

## Трейлинг-стопы

### TrailStop (Трейл Стоп)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `/*Could not decode attribute arguments.*/`
- **Описание**: Динамический стоп-лосс, следующий за ценой с заданным отступом в процентах.
- **Описание от разработчиков**: То же, что и 'Следящий стоп абс.', но параметры ведения задаются в процентах.
- **Примеры**: [Стратегия Alligator](http://www.tslab.ru/files/script/Alligator_tradable.tscript)

### TrailStopAbs (Трейл Стоп Абс.)
- **Входные параметры**: `IPosition pos` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `/*Could not decode attribute arguments.*/`
- **Описание**: Динамический стоп-лосс с отступом в абсолютных денежных величинах (пунктах).
- **Описание от разработчиков**: Следящий стоп, значения ведения задаются в абсолютных величинах. У блока 3 параметра, которые описывают два режима работы.
- **Примеры**: [Стратегия IndexTrade](http://www.tslab.ru/files/script/IndexTrade.tscript)

## Специальные функции

### HoldSignalForNBars (Удерживать сигнал N баров)
- **Входные параметры**: `IList<bool> source` — входной булевский сигнал
- **Выход**: `IList<bool>`
- **Описание**: Продлевает длительность сигнала «Истина» на заданное количество баров после его появления.
- **Описание от разработчиков**: Удерживает сигнал 'Истина' в течение заданного количества баров после его появления.

### PosActiveNameExit (Последний выход имеет такое имя)
- **Входные параметры**: `ISecurity source` — финансовый инструмент, `int barNum` — номер текущего бара
- **Выход**: `bool`
- **Описание**: Проверяет, был ли последний выход из позиции выполнен через блок закрытия с указанным именем.
- **Описание от разработчиков**: В параметре задается имя блока закрытия позиции. Значение данного блока верно, если последним закрытием по финансовому инструменту было закрытие с заданным именем.

## Изменённые позиции

### PositionChangeExitPrice (Цена выхода из измененной позиции)
- **Входные параметры**: `IPosition position` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Цена последнего выхода из сложносоставной позиции.
- **Описание от разработчиков**: Показывает цену последнего выхода из сложносоставной позиции.

### PositionChangeExitBarNumber (Номер бара выхода из измененной позиции)
- **Входные параметры**: `IPosition position` — объект позиции, `int barNum` — номер текущего бара
- **Выход**: `double`
- **Описание**: Номер бара выхода из измененной сложносоставной позиции.
- **Описание от разработчиков**: Показывает номер бара выхода из измененной сложносоставной позиции.

---

## Советы по использованию

1. **Для анализа серии сделок** используйте связку `ProfitsCount` / `DrowdownCount` + `HasTwoLoss` для динамической коррекции размера позиции после убыточных серий.

2. **При работе с усреднениями** различайте:
   - `PositionShares` — исходный объём позиции
   - `PositionSharesByBar` — текущий объём с учётом докупок/продаж
   - `BalancedPrice` — средняя цена входа для текущей позиции

3. **Для точного расчёта прибыли** учитывайте разницу между:
   - `Profit` — абсолютный доход в валюте
   - `ProfitPct` — доход в процентах от цены входа
   Оба значения рассчитываются на один лот/контракт.

4. **При использовании трейлинг-стопов**:
   - `TrailStop` — удобен для волатильных инструментов (отступ в %)
   - `TrailStopAbs` — предпочтителен для фьючерсов с фиксированным шагом цены

5. **Для анализа качества входов** применяйте комбинацию:
   - `MAE`/`MFE` — для оценки качества точки входа
   - `BarsHeld` — для анализа длительности удержания
   - `MinutesInPosition` — для внутридневных стратегий

6. **Виртуальные позиции** (`PositionIsVirtualHandler`) полезны при тестировании логики выхода без реального исполнения заявок в режиме симуляции портфеля.

7. **Для отслеживания времени** используйте:
   - `DaysInPosition` — для свинговых стратегий
   - `MinutesInPosition` — для скальпинга и внутридневной торговли

8. **При работе с именованными блоками** кубик `PosActiveNameExit` позволяет точно определить, какой именно блок закрытия сработал последним — это полезно при множестве условий выхода.

#tslab #position #торговля #анализ_позиций #риск_менеджмент